syntax = "proto3";

package mpc.v1;

import "mpc/v1/mpc.proto";

option go_package = "github.com/SafeMPC/mpc-service/pb/mpc/v1;mpc";

// SignerService 由 mpc-signer 实现，供 mpc-service 调用
// 使用 mpc.proto 中定义的消息类型
service SignerService {
  // DKG 相关（使用 mpc.proto 中的 StartDKGRequest/Response）
  rpc StartDKG(StartDKGRequest) returns (StartDKGResponse);
  rpc GetDKGStatus(GetDKGStatusRequest) returns (DKGStatusResponse);
  
  // 签名相关（使用 mpc.proto 中的 StartSignRequest/Response）
  rpc StartSign(StartSignRequest) returns (StartSignResponse);
  rpc GetSignStatus(GetSignStatusRequest) returns (SignStatusResponse);
  
  // 协议消息中继（从 Client 通过 Service 中继到 Signer）
  rpc RelayProtocolMessage(RelayMessageRequest) returns (RelayMessageResponse);
  
  // 健康检查
  rpc Ping(PingRequest) returns (PongResponse);
}

// ============================================
// DKG 状态查询（新增）
// ============================================

message GetDKGStatusRequest {
  string session_id = 1;
}

message DKGStatusResponse {
  string session_id = 1;
  string status = 2;  // "pending", "running", "completed", "failed"
  int32 current_round = 3;
  int32 total_rounds = 4;
  string public_key = 5;  // 完成后返回（hex）
  string error = 6;
}

// ============================================
// 签名状态查询（新增）
// ============================================

message GetSignStatusRequest {
  string session_id = 1;
}

message SignStatusResponse {
  string session_id = 1;
  string status = 2;
  int32 current_round = 3;
  int32 total_rounds = 4;
  string signature = 5;  // 完成后返回（hex）
  string error = 6;
}

// ============================================
// 协议消息中继
// ============================================

message RelayMessageRequest {
  string session_id = 1;
  string from_node_id = 2;    // "mobile-p1"
  string to_node_id = 3;      // "server-signer-p2"
  bytes message_data = 4;     // tss-lib 序列化的消息
  int32 round = 5;
  bool is_broadcast = 6;
  string timestamp = 7;
  bytes client_signature = 8;  // Client (P1) 使用 Passkey 私钥签名（E2E 认证）
}

message RelayMessageResponse {
  bool accepted = 1;
  string message_id = 2;
  // 如果 Signer 有回复消息，直接返回
  bytes reply_message = 3;
  bool has_reply = 4;
  int32 next_round = 5;
}

// ============================================
// 健康检查
// ============================================

message PingRequest {
  string from_service = 1;
  string timestamp = 2;
}

message PongResponse {
  bool alive = 1;
  string node_id = 2;
  string timestamp = 3;
}
