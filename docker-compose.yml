# mpc-signer docker-compose.yml
# 只启动 Signer 节点，连接到 mpc-service 的基础设施

services:
  # ============================================
  # Server Signer P2 节点（签名节点 P2 - Signer Node）
  # ============================================
  server-signer-p2:
    build:
      context: .
      target: development
    ports:
      - "8081:8081"  # HTTP API
      - "9091:9091"  # gRPC
    working_dir: /app
    user: development
    volumes:
      - .:/app:delegated
      - go-pkg:/go/pkg
      - workdir-api-tmp:/app/api/tmp
      - workdir-bin:/app/bin
      - workdir-tmp:/app/tmp
      - server-signer-p2-key-shares:/app/var/lib/mpc/key-shares
    environment:
      # Database configuration - 连接到 mpc-service 的 PostgreSQL
      PGDATABASE: "mpc-dev-db"
      PGUSER: "dbuser"
      PGPASSWORD: "dbpass"
      PGHOST: "host.docker.internal"  # 连接到宿主机上 mpc-service 的 postgres
      PGPORT: "5432"
      PGSSLMODE: "disable"
      PSQL_DBNAME: "spec"
      PSQL_USER: "dbuser"
      PSQL_PASS: "dbpass"
      PSQL_HOST: "host.docker.internal"
      PSQL_PORT: "5432"
      PSQL_SSLMODE: "disable"
      PROJECT_ROOT_DIR: "/app"
      SERVER_LOGGER_PRETTY_PRINT_CONSOLE: "true"
      SERVER_MANAGEMENT_SECRET: "mgmtpass"
      CHANGIE_CONFIG_PATH: "/app/.changie-go-starter.yaml"
      # MPC Signer configuration
      MPC_NODE_TYPE: "signer"
      MPC_NODE_ID: "server-signer-p2"
      MPC_SERVICE_ENDPOINT: "host.docker.internal:9090"  # 连接到 mpc-service
      MPC_SERVICE_ADDR: "host.docker.internal:9090"      # Signer 上报结果/管理面调用的地址（ManagementService）
      MPC_CONSUL_ADDRESS: "host.docker.internal:8500"    # 连接到 mpc-service 的 Consul
      MPC_REGISTER_ADDRESS: "192.168.111.183"           # 注册到 Consul 的地址（真机/Service 可访问）
      MPC_STORAGE_BACKEND: "postgresql"
      MPC_REDIS_ENDPOINT: "host.docker.internal:6379"    # 连接到 mpc-service 的 Redis
      MPC_KEY_SHARE_STORAGE_PATH: "/app/var/lib/mpc/key-shares"
      MPC_KEY_SHARE_ENCRYPTION_KEY: "your-encryption-key-here-change-in-production"
      MPC_SUPPORTED_PROTOCOLS: "gg18,gg20,frost"
      MPC_DEFAULT_PROTOCOL: "frost"
      SERVER_ECHO_LISTEN_ADDRESS: ":8081"
      SERVER_ECHO_BASE_URL: "http://localhost:8081"
      MPC_HTTP_PORT: "8081"
      MPC_GRPC_PORT: "9091"
      MPC_TLS_ENABLED: "false" # 本地/移动端直连测试：关闭 TLS（iOS 使用 insecure gRPC）
      MPC_TLS_CERT_FILE: "/app/certs/server.crt"
      MPC_TLS_KEY_FILE: "/app/certs/server.key"
      MPC_TLS_CA_CERT_FILE: "/app/certs/ca.crt"
      MPC_ENABLE_AUDIT: "true"
      MPC_ENABLE_POLICY: "true"
      MPC_KEY_ROTATION_DAYS: "0"
      MPC_MAX_CONCURRENT_SESSIONS: "100"
      MPC_MAX_CONCURRENT_SIGNINGS: "50"
      MPC_SESSION_TIMEOUT: "300"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command:
      - /bin/sh
      - -c
      - |
        sudo chown -R development:development /app/api/tmp
        sudo chown -R development:development /app/bin
        sudo chown -R development:development /app/tmp
        sudo mkdir -p /app/var/lib/mpc/key-shares
        sudo chown -R development:development /app/var/lib/mpc/key-shares
        chmod +x /app/rksh
        git config --global --add safe.directory /app
        # 首次启动需要构建
        if [ ! -f /app/bin/app ]; then
          echo "Building application..."
          cd /app && make build
        fi
        # 启动应用，如果失败则保持容器运行
        /app/bin/app server || while sleep 1000; do :; done
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/9091'"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s  # 给构建留足时间
    extra_hosts:
      - "host.docker.internal:host-gateway"  # 允许访问宿主机服务

volumes:
  # Go module cache
  go-pkg:

  # Temporary directories
  workdir-api-tmp:
  workdir-bin:
  workdir-tmp:

  # MPC key shares storage
  server-signer-p2-key-shares:
